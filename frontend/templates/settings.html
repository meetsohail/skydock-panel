{% extends "base.html" %}

{% block title %}Settings - SkyDock Panel{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<div x-data="settings()" x-init="loadSettings()" class="space-y-6">
    <!-- Change Password -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Change Password</h3>
        <form @submit.prevent="changePassword()" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Password</label>
                <input type="password" x-model="passwordForm.current_password" required
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">New Password</label>
                <input type="password" x-model="passwordForm.new_password" required
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirm New Password</label>
                <input type="password" x-model="passwordForm.confirm_password" required
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            </div>
            <button type="submit" 
                    class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md">
                Update Password
            </button>
        </form>
    </div>

    <!-- SSH Profile Settings -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">SSH Profile</h3>
        <form @submit.prevent="saveSSHProfile()" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">SSH Username</label>
                <input type="text" x-model="sshProfile.ssh_username" required
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">SSH Password</label>
                <input type="password" x-model="sshProfile.ssh_password"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                       placeholder="Leave empty to keep current password">
            </div>
            <button type="submit" 
                    class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md">
                Save SSH Profile
            </button>
        </form>
    </div>

    <!-- General Settings -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">General Settings</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Panel Port</label>
                <input type="number" :value="panelPort" disabled
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Configured during installation</p>
            </div>
        </div>
    </div>
</div>

<script>
function settings() {
    return {
        panelPort: 2083,
        passwordForm: {
            current_password: '',
            new_password: '',
            confirm_password: ''
        },
        sshProfile: {
            ssh_username: 'root',
            ssh_password: ''
        },
        loadSettings() {
            this.loadSSHProfile();
            this.loadPanelPort();
        },
        loadPanelPort() {
            fetch('/api/settings/panel-port/')
                .then(response => response.json())
                .then(data => {
                    if (data.port) {
                        this.panelPort = data.port;
                    }
                })
                .catch(error => {
                    console.error('Error loading panel port:', error);
                });
        },
        loadSSHProfile() {
            fetch('/api/auth/ssh-profile/')
                .then(response => response.json())
                .then(data => {
                    if (data.id) {
                        this.sshProfile.ssh_username = data.ssh_username || 'root';
                        // Don't load password for security
                    }
                })
                .catch(error => {
                    console.error('Error loading SSH profile:', error);
                });
        },
        changePassword() {
            if (this.passwordForm.new_password !== this.passwordForm.confirm_password) {
                alert('New password and confirm password do not match');
                return;
            }
            
            if (this.passwordForm.new_password.length < 6) {
                alert('New password must be at least 6 characters long');
                return;
            }
            
            fetch('/api/auth/change-password/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCookie('csrftoken')
                },
                body: JSON.stringify({
                    current_password: this.passwordForm.current_password,
                    new_password: this.passwordForm.new_password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Password updated successfully!');
                    this.passwordForm = {
                        current_password: '',
                        new_password: '',
                        confirm_password: ''
                    };
                } else {
                    alert('Error: ' + (data.error || 'Failed to update password'));
                }
            })
            .catch(error => {
                console.error('Error changing password:', error);
                alert('Error changing password');
            });
        },
        saveSSHProfile() {
            fetch('/api/auth/ssh-profile/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCookie('csrftoken')
                },
                body: JSON.stringify({
                    ssh_username: this.sshProfile.ssh_username,
                    auth_type: 'password',
                    ssh_password: this.sshProfile.ssh_password || undefined
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    alert('SSH profile saved successfully!');
                    this.sshProfile.ssh_password = '';
                } else {
                    alert('Error: ' + (data.error || 'Failed to save SSH profile'));
                }
            })
            .catch(error => {
                console.error('Error saving SSH profile:', error);
                alert('Error saving SSH profile');
            });
        },
        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }
}
</script>
{% endblock %}
